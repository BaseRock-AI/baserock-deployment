---
# --- flink-job ---
apiVersion: flink.apache.org/v1beta1
kind: FlinkDeployment
metadata:
  namespace: ${NAMESPACE}
  name: flink-aggregation-job
spec:
  image: ${FLINK_IMAGE}
  flinkVersion: v1_19
  flinkConfiguration:
    taskmanager.numberOfTaskSlots: "1"
  serviceAccount: flink
  jobManager:
    resource:
      memory: "1024m"
      cpu: 1
    podTemplate:
      apiVersion: v1
      kind: Pod
      metadata:
        name: pod-template
      spec:
        containers:
          - name: flink-main-container
            image: ${FLINK_IMAGE}
            imagePullPolicy: Always
            env:
              - name: MQ_HOST
                value: ${MQ_HOST_NAME}
              - name: MQ_VIRTUAL_HOST
                value: "/"
              - name: MQ_USERNAME
                value: ${MQ_USERNAME}
              - name: MQ_PASSWORD
                value: ${MQ_PASSWORD}
              - name: MONGO_DB_CONNECTION_STRING
                value: ${MONGO_URL}
              - name: MONGO_DB_HOST
                value:
              - name: MONGO_DB_PORT
                value: ${}
              - name: MONGO_DB_ROOT_PASSWORD
                value: ${MONGO_DB_PASSWORD}
              - name: MONGO_DB_USER
                value: ${MONGO_DB_USER}
              - name: REFRESH_INTERVAL
                value: "30000"
              - name: DB_ROOT_PASSWORD
                value: ${MONGO_DB_PASSWORD}
              - name: SPAN_DURATION_IN_SECONDS
                value: "60"
  taskManager:
    resource:
      memory: "1024m"
      cpu: 1
    podTemplate:
      spec:
        containers:
          - name: flink-main-container
            env:
              - name: MQ_HOST
                value: ${RABBITMQ_SERVICE_DEPLOYMENT}
              - name: MQ_VIRTUAL_HOST
                value: ${RABBITMQ_SERVICE_DEPLOYMENT}
              - name: MQ_USERNAME
                value: ${MQ_USERNAME}
              - name: MQ_PASSWORD
                value: ${MQ_PASSWORD}
              - name: SPAN_DURATION_IN_SECONDS
                value: "60"
  job:
    jarURI: local:///opt/flink/usrlib/FlinkJob-1.0-SNAPSHOT.jar
    entryClass: "org.sapient.Main"
    parallelism: 1
    upgradeMode: stateless
