name: Trigger All Services Workflows

on:
  workflow_dispatch:
    inputs:
      trigger_type:
        description: 'Type of trigger for the workflows'
        required: true
        default: 'workflow_dispatch'
        type: choice
        options:
          - workflow_dispatch
          - push
  push:

permissions:
  contents: read
  actions: write

jobs:
  trigger-learning-engine:
    runs-on: ubuntu-latest
    outputs:
      workflow_run_id: ${{ steps.trigger.outputs.workflow_run_id }}
    steps:
      - name: Trigger Learning Engine Workflow
        id: trigger
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.CROSS_REPO_TOKEN }}
          script: |
            const { data: workflow } = await github.rest.actions.createWorkflowDispatch({
              owner: 'BaseRock-AI',
              repo: 'learning-engine',
              workflow_id: 'upload-all-services.yml',
              ref: 'SM-1223/consolidated-push-tags-for-service',
              inputs: {
                // The workflow will use its own trigger logic based on the event
              }
            });
            
            // Wait a moment for the workflow to start
            await new Promise(resolve => setTimeout(resolve, 5000));
            
            // Get the workflow run ID
            const { data: runs } = await github.rest.actions.listWorkflowRuns({
              owner: 'BaseRock-AI',
              repo: 'learning-engine',
              workflow_id: 'upload-all-services.yml',
              per_page: 1
            });
            
            if (runs.workflow_runs.length > 0) {
              core.setOutput('workflow_run_id', runs.workflow_runs[0].id);
              console.log(`Triggered Learning Engine workflow run: ${runs.workflow_runs[0].id}`);
            } else {
              throw new Error('Failed to get workflow run ID');
            }

  trigger-integration-testing:
    runs-on: ubuntu-latest
    outputs:
      workflow_run_id: ${{ steps.trigger.outputs.workflow_run_id }}
    steps:
      - name: Trigger Integration Testing Workflow
        id: trigger
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.CROSS_REPO_TOKEN }}
          script: |
            const { data: workflow } = await github.rest.actions.createWorkflowDispatch({
              owner: 'BaseRock-AI',
              repo: 'integration-testing',
              workflow_id: 'upload-all-services.yml',
              ref: 'SM-1223/consolidated-push-tags-for-service',
              inputs: {
                // The workflow will use its own trigger logic based on the event
              }
            });
            
            // Wait a moment for the workflow to start
            await new Promise(resolve => setTimeout(resolve, 5000));
            
            // Get the workflow run ID
            const { data: runs } = await github.rest.actions.listWorkflowRuns({
              owner: 'BaseRock-AI',
              repo: 'integration-testing',
              workflow_id: 'upload-all-services.yml',
              per_page: 1
            });
            
            if (runs.workflow_runs.length > 0) {
              core.setOutput('workflow_run_id', runs.workflow_runs[0].id);
              console.log(`Triggered Integration Testing workflow run: ${runs.workflow_runs[0].id}`);
            } else {
              throw new Error('Failed to get workflow run ID');
            }

  wait-for-learning-engine:
    needs: trigger-learning-engine
    runs-on: ubuntu-latest
    outputs:
      django_tag: ${{ steps.get-tags.outputs.django_tag }}
      celery_tag: ${{ steps.get-tags.outputs.celery_tag }}
      upcaster_tag: ${{ steps.get-tags.outputs.upcaster_tag }}
    steps:
      - name: Wait for Learning Engine Workflow to Complete
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.CROSS_REPO_TOKEN }}
          script: |
            const maxWaitTime = 30 * 60 * 1000; // 30 minutes
            const checkInterval = 30 * 1000; // 30 seconds
            const startTime = Date.now();
            
            while (Date.now() - startTime < maxWaitTime) {
              const { data: run } = await github.rest.actions.getWorkflowRun({
                owner: 'BaseRock-AI',
                repo: 'learning-engine',
                run_id: ${{ needs.trigger-learning-engine.outputs.workflow_run_id }}
              });
              
              console.log(`Learning Engine workflow status: ${run.status} (${run.conclusion || 'running'})`);
              
              if (run.status === 'completed') {
                if (run.conclusion === 'success') {
                  console.log('Learning Engine workflow completed successfully!');
                  break;
                } else {
                  console.log(`‚ùå Learning Engine workflow failed with conclusion: ${run.conclusion}`);
                  
                  // Get detailed job information
                  try {
                    const { data: jobs } = await github.rest.actions.listJobsForWorkflowRun({
                      owner: 'BaseRock-AI',
                      repo: 'learning-engine',
                      run_id: ${{ needs.trigger-learning-engine.outputs.workflow_run_id }}
                    });
                    
                    console.log('Job details:');
                    for (const job of jobs.jobs) {
                      console.log(`- Job: ${job.name}, Status: ${job.status}, Conclusion: ${job.conclusion}`);
                      if (job.conclusion === 'failure') {
                        console.log(`  ‚ùå Failed job: ${job.name}`);
                      }
                    }
                  } catch (error) {
                    console.log(`Could not get job details: ${error.message}`);
                  }
                  
                  throw new Error(`Learning Engine workflow failed with conclusion: ${run.conclusion}`);
                }
              }
              
              await new Promise(resolve => setTimeout(resolve, checkInterval));
            }
            
            if (Date.now() - startTime >= maxWaitTime) {
              throw new Error('Learning Engine workflow timed out');
            }

      - name: Get Learning Engine Tags
        id: get-tags
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.CROSS_REPO_TOKEN }}
          script: |
            // Wait a bit for tags to be created and retry if needed
            let tags = [];
            let retryCount = 0;
            const maxRetries = 3;
            
            while (retryCount < maxRetries) {
              console.log(`Attempt ${retryCount + 1} to get tags from learning-engine...`);
              
              // Wait before each attempt
              if (retryCount > 0) {
                console.log('Waiting 30 seconds before retry...');
                await new Promise(resolve => setTimeout(resolve, 30000));
              }
              
              try {
                const { data: tagData } = await github.rest.repos.listTags({
                  owner: 'BaseRock-AI',
                  repo: 'learning-engine',
                  per_page: 10
                });
                
                tags = tagData;
                console.log(`Found ${tags.length} tags in learning-engine repository:`);
                tags.forEach((tag, index) => {
                  console.log(`  ${index + 1}. ${tag.name}`);
                });
                
                // If we found tags, break out of retry loop
                if (tags.length > 0) {
                  break;
                }
              } catch (error) {
                console.log(`Error getting tags: ${error.message}`);
              }
              
              retryCount++;
            }
            
            // Find the latest tags for each service
            let djangoTag = '';
            let celeryTag = '';
            let upcasterTag = '';
            
            // The learning-engine workflow creates tags without prefix
            // We'll get the latest tag
            if (tags.length > 0) {
              const latestTag = tags[0].name;
              djangoTag = latestTag;
              celeryTag = latestTag;
              upcasterTag = latestTag;
            }
            
            core.setOutput('django_tag', djangoTag);
            core.setOutput('celery_tag', celeryTag);
            core.setOutput('upcaster_tag', upcasterTag);
            
            console.log(`Learning Engine Tags - Django: ${djangoTag}, Celery: ${celeryTag}, Upcaster: ${upcasterTag}`);

  wait-for-integration-testing:
    needs: trigger-integration-testing
    runs-on: ubuntu-latest
    outputs:
      flink_tag: ${{ steps.get-tags.outputs.flink_tag }}
      learning_engine_service_tag: ${{ steps.get-tags.outputs.learning_engine_service_tag }}
      client_tag: ${{ steps.get-tags.outputs.client_tag }}
    steps:
      - name: Wait for Integration Testing Workflow to Complete
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.CROSS_REPO_TOKEN }}
          script: |
            const maxWaitTime = 30 * 60 * 1000; // 30 minutes
            const checkInterval = 30 * 1000; // 30 seconds
            const startTime = Date.now();
            
            while (Date.now() - startTime < maxWaitTime) {
              const { data: run } = await github.rest.actions.getWorkflowRun({
                owner: 'BaseRock-AI',
                repo: 'integration-testing',
                run_id: ${{ needs.trigger-integration-testing.outputs.workflow_run_id }}
              });
              
              console.log(`Integration Testing workflow status: ${run.status} (${run.conclusion || 'running'})`);
              
              if (run.status === 'completed') {
                if (run.conclusion === 'success') {
                  console.log('Integration Testing workflow completed successfully!');
                  break;
                } else {
                  console.log(`‚ùå Integration Testing workflow failed with conclusion: ${run.conclusion}`);
                  
                  // Get detailed job information
                  try {
                    const { data: jobs } = await github.rest.actions.listJobsForWorkflowRun({
                      owner: 'BaseRock-AI',
                      repo: 'integration-testing',
                      run_id: ${{ needs.trigger-integration-testing.outputs.workflow_run_id }}
                    });
                    
                    console.log('Job details:');
                    for (const job of jobs.jobs) {
                      console.log(`- Job: ${job.name}, Status: ${job.status}, Conclusion: ${job.conclusion}`);
                      if (job.conclusion === 'failure') {
                        console.log(`  ‚ùå Failed job: ${job.name}`);
                      }
                    }
                  } catch (error) {
                    console.log(`Could not get job details: ${error.message}`);
                  }
                  
                  throw new Error(`Integration Testing workflow failed with conclusion: ${run.conclusion}`);
                }
              }
              
              await new Promise(resolve => setTimeout(resolve, checkInterval));
            }
            
            if (Date.now() - startTime >= maxWaitTime) {
              throw new Error('Integration Testing workflow timed out');
            }

      - name: Get Integration Testing Tags
        id: get-tags
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.CROSS_REPO_TOKEN }}
          script: |
            // Wait a bit for tags to be created and retry if needed
            let tags = [];
            let retryCount = 0;
            const maxRetries = 3;
            
            while (retryCount < maxRetries) {
              console.log(`Attempt ${retryCount + 1} to get tags from integration-testing...`);
              
              // Wait before each attempt
              if (retryCount > 0) {
                console.log('Waiting 30 seconds before retry...');
                await new Promise(resolve => setTimeout(resolve, 30000));
              }
              
              try {
                const { data: tagData } = await github.rest.repos.listTags({
                  owner: 'BaseRock-AI',
                  repo: 'integration-testing',
                  per_page: 20
                });
                
                tags = tagData;
                console.log(`Found ${tags.length} tags in integration-testing repository:`);
                tags.forEach((tag, index) => {
                  console.log(`  ${index + 1}. ${tag.name}`);
                });
                
                // If we found tags, break out of retry loop
                if (tags.length > 0) {
                  break;
                }
              } catch (error) {
                console.log(`Error getting tags: ${error.message}`);
              }
              
              retryCount++;
            }
            
            // Find the latest tags for each service
            let flinkTag = '';
            let learningEngineServiceTag = '';
            let clientTag = '';
            
            // The integration-testing workflow creates tags with prefixes
            for (const tag of tags) {
              if (tag.name.startsWith('flink-') && !flinkTag) {
                // Extract version from flink-0.56.1-SM-1223-consolidated-push-tags-for-service.3
                const versionMatch = tag.name.match(/^flink-(.+)$/);
                if (versionMatch) {
                  flinkTag = versionMatch[1];
                }
              } else if (tag.name.startsWith('learning-engine-service-') && !learningEngineServiceTag) {
                // Extract version from learning-engine-service-0.187.2-SM-1223-consolidated-push-tags-for-service.4
                const versionMatch = tag.name.match(/^learning-engine-service-(.+)$/);
                if (versionMatch) {
                  learningEngineServiceTag = versionMatch[1];
                }
              } else if (tag.name.startsWith('client-') && !clientTag) {
                // Extract version from client-0.69.1-SM-1223-consolidated-push-tags-for-service.4
                const versionMatch = tag.name.match(/^client-(.+)$/);
                if (versionMatch) {
                  clientTag = versionMatch[1];
                }
              }
              
              // Break if we found all tags
              if (flinkTag && learningEngineServiceTag && clientTag) {
                break;
              }
            }
            
            core.setOutput('flink_tag', flinkTag);
            core.setOutput('learning_engine_service_tag', learningEngineServiceTag);
            core.setOutput('client_tag', clientTag);
            
            console.log(`Integration Testing Tags - Flink: ${flinkTag}, Learning Engine Service: ${learningEngineServiceTag}, Client: ${clientTag}`);

  summary:
    needs: [wait-for-learning-engine, wait-for-integration-testing]
    runs-on: ubuntu-latest
    steps:
      - name: Display All Service Tags
        run: |
          echo "üéâ All workflows completed successfully!"
          echo ""
          echo "üìã Complete Service Tags Summary:"
          echo "=================================="
          echo ""
          echo "üè≠ Learning Engine Repository Services (BaseRock-AI):"
          echo "  ‚Ä¢ Django Server: ${{ needs.wait-for-learning-engine.outputs.django_tag }}"
          echo "  ‚Ä¢ Celery Worker: ${{ needs.wait-for-learning-engine.outputs.celery_tag }}"
          echo "  ‚Ä¢ Upcaster: ${{ needs.wait-for-learning-engine.outputs.upcaster_tag }}"
          echo ""
          echo "üîß Integration Testing Repository Services (BaseRock-AI):"
          echo "  ‚Ä¢ Flink Job: ${{ needs.wait-for-integration-testing.outputs.flink_tag }}"
          echo "  ‚Ä¢ Learning Engine Service: ${{ needs.wait-for-integration-testing.outputs.learning_engine_service_tag }}"
          echo "  ‚Ä¢ Client: ${{ needs.wait-for-integration-testing.outputs.client_tag }}"
          echo ""
          echo "üê≥ Docker Images:"
          echo "=================="
          echo "Learning Engine Services:"
          echo "  ‚Ä¢ gcr.io/production-385606/le-django-server:${{ needs.wait-for-learning-engine.outputs.django_tag }}"
          echo "  ‚Ä¢ gcr.io/production-385606/celery-worker:${{ needs.wait-for-learning-engine.outputs.celery_tag }}"
          echo "  ‚Ä¢ gcr.io/production-385606/upcaster:${{ needs.wait-for-learning-engine.outputs.upcaster_tag }}"
          echo ""
          echo "Integration Testing Services:"
          echo "  ‚Ä¢ gcr.io/production-385606/flinkjob-rabbitmq-aggregation:${{ needs.wait-for-integration-testing.outputs.flink_tag }}"
          echo "  ‚Ä¢ gcr.io/production-385606/baserock-backend/learning-engine-service:${{ needs.wait-for-integration-testing.outputs.learning_engine_service_tag }}"
          echo "  ‚Ä¢ gcr.io/production-385606/client:${{ needs.wait-for-integration-testing.outputs.client_tag }}"
          echo ""
          echo "üìù All tags have been pushed to GitHub releases."
          echo "‚úÖ All services have been built and tagged successfully!" 